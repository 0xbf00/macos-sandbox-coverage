import os
import json
import argparse


def process_entries(root_folder):
    result = dict()

    entries = [ os.path.join(root_folder, x) for x in os.listdir(root_folder) ]

    for entry in entries:
        print('Processing {}'.format(entry))

        with open(entry) as infile:
            matching_result = json.load(infile)
            for _, matched_rule in matching_result.items():
                result[matched_rule] = result.get(matched_rule, 0) + 1

    return result


def main():
    parser = argparse.ArgumentParser()
    parser.add_argument('--normalised-matches', required=True,
                        help='The directory containing normalised and mapped matching results, as generated by match_normalised.py')
    parser.add_argument('--output', required=True,
                        help='Where to place the final matching result JSON file.')

    args = parser.parse_args()
    res = process_entries(args.normalised_matches)

    with open(args.output, "w") as outfile:
        json.dump(list(sorted(res.items())), outfile, indent=4)


if __name__ == "__main__":
    main()